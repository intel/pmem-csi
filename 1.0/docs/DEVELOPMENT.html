<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Develop and Contribute &mdash; PMEM-CSI v1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/override.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Automated testing" href="autotest.html" />
    <link rel="prev" title="Installation and Usage" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> PMEM-CSI
          </a>
              <div class="version">
                v1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Introduction to PMEM-CSI for Kubernetes*</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design and architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation and Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Develop and Contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-pmem-csi">Build PMEM-CSI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#code-quality">Code quality</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coding-style">Coding style</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-validation">Input validation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#release-management">Release management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#branching">Branching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tagging">Tagging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#release-checklist">Release checklist</a></li>
<li class="toctree-l3"><a class="reference internal" href="#release-pmem-csi-operator">Release PMEM-CSI operator</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#apis">APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csi-api">CSI API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#network-ports">Network ports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#local-sockets">Local sockets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#command-line-arguments">Command line arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">Environment variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance-and-resource-measurements">Performance and resource measurements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-system-directories-in-a-container">Accessing system directories in a container</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#read-only-access-to-sys">Read-only access to /sys</a></li>
<li class="toctree-l3"><a class="reference internal" href="#access-to-dev-of-host">Access to /dev of host</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#repository-elements-that-are-generated-or-created-separately">Repository elements that are generated or created separately</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#top-level-readme-diagrams-describing-lvm-and-direct-device-modes">Top-level README diagrams describing LVM and Direct device modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#top-level-readme-diagram-describing-communication-channels">Top-level README diagram describing communication channels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#diagrams-describing-provisioning-sequence">Diagrams describing provisioning sequence</a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-of-contents-in-readme-and-development">Table of Contents in README and DEVELOPMENT</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#build-edit-and-deploy-the-read-the-docs-site">Build, edit, and deploy the Read the Docs site</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build">Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#edit">Edit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-link-handling">Custom link handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploying-with-github-actions">Deploying with GitHub actions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autotest.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/readme.html">Application examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/pmem-csi">Project GitHub repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PMEM-CSI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Develop and Contribute</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="develop-and-contribute">
<h1>Develop and Contribute<a class="headerlink" href="#develop-and-contribute" title="Permalink to this headline"></a></h1>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline"></a></h2>
<section id="build-pmem-csi">
<h3>Build PMEM-CSI<a class="headerlink" href="#build-pmem-csi" title="Permalink to this headline"></a></h3>
<ol class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">build-images</span></code> to produce Docker* container images.g180</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">push-images</span></code> to push Docker container images to a Docker image
registry. The default is to push to a local
<a class="reference external" href="https://docs.docker.com/registry/deploying/">Docker registry</a>.
Other registries can be configured by setting the variables
described in the <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/test/test-config.sh">test-config.sh</a> file. See the
<a class="reference external" href="autotest.html#configuration-options">configuration options</a>
section below. Alternatively, the registry can also be set with a make
variable:
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">push-images</span> <span class="pre">REGISTRY_NAME=my-registry:5000</span></code></p></li>
</ol>
<p>See the <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/Makefile">Makefile</a> for additional make targets and possible make variables.</p>
<p>The source code is developed and tested using the version of Go that
is set with <code class="docutils literal notranslate"><span class="pre">GO_VERSION</span></code> in the <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/Dockerfile">Dockerfile</a>. Other
versions may or may not work. In particular, <code class="docutils literal notranslate"><span class="pre">test_fmt</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_vendor</span></code> are known to be sensitive to the version of Go.</p>
</section>
</section>
<section id="code-quality">
<h2>Code quality<a class="headerlink" href="#code-quality" title="Permalink to this headline"></a></h2>
<section id="coding-style">
<h3>Coding style<a class="headerlink" href="#coding-style" title="Permalink to this headline"></a></h3>
<p>The normal Go style guide applies and is enforced by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>, which
calls <code class="docutils literal notranslate"><span class="pre">gofmt</span></code>.</p>
</section>
<section id="input-validation">
<h3>Input validation<a class="headerlink" href="#input-validation" title="Permalink to this headline"></a></h3>
<p>In most cases, input comes from a trusted source because network
communication is protected by mutual TLS. The <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> binaries
run with the same privileges as the user invoking it.</p>
<p>Nonetheless, input needs to be validated to catch mistakes:</p>
<ul class="simple">
<li><p>Detect incorrect parameters for <code class="docutils literal notranslate"><span class="pre">kubectl</span></code></p></li>
<li><p>Ensure that messages passed to gRPC API implementations
in registry, controller, and driver have all required fields</p></li>
<li><p>The gRPC implementation rejects incoming messages that are too large
(https://godoc.org/google.golang.org/grpc#MaxRecvMsgSize) and
refuses to send messages that are larger
(https://godoc.org/google.golang.org/grpc#MaxSendMsgSize)</p></li>
<li><p>Webhook and metrics SDK code validates input before invoking PMEM-CSI</p></li>
</ul>
</section>
</section>
<section id="release-management">
<h2>Release management<a class="headerlink" href="#release-management" title="Permalink to this headline"></a></h2>
<section id="branching">
<h3>Branching<a class="headerlink" href="#branching" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">master</span></code> branch is the main branch. It is guaranteed to have
passed full CI testing. However, the Dockerfile uses whatever is
the latest upstream content for the base distribution and therefore
tests results are not perfectly reproducible.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">devel</span></code> branch contains additional commits on top of <code class="docutils literal notranslate"><span class="pre">master</span></code>
which might not have been tested in that combination yet. Therefore it
may be a bit less stable than <code class="docutils literal notranslate"><span class="pre">master</span></code>. The <code class="docutils literal notranslate"><span class="pre">master</span></code> branch gets
advanced via a fast-forward merge after successful testing by the CI job
that rebuilds and tests the <code class="docutils literal notranslate"><span class="pre">devel</span></code> branch.</p>
<p>Code changes are made via pull requests against <code class="docutils literal notranslate"><span class="pre">devel</span></code>. Each of them
will be tested separately by the CI system before merging, but only a
subset of the tests can be run due to time constraints.</p>
<p>Beware that after merging one PR, the existing pre-merge tests results
for other PRs become stale because they were based on the old <code class="docutils literal notranslate"><span class="pre">devel</span></code>
branch. Because <code class="docutils literal notranslate"><span class="pre">devel</span></code> is allowed to be less stable than <code class="docutils literal notranslate"><span class="pre">master</span></code>, it
is okay to merge two PRs quickly after one another without
retesting. If two merged PRs don’t have code conflicts
(which would be detected by GitHub*) but nonetheless don’t work
together, the combined testing in the <code class="docutils literal notranslate"><span class="pre">devel</span></code> branch will find
that. This blocks updating <code class="docutils literal notranslate"><span class="pre">master</span></code> and thus needs to be dealt with
quickly.</p>
<p>Releases are created by branching <code class="docutils literal notranslate"><span class="pre">release-x.y</span></code> from <code class="docutils literal notranslate"><span class="pre">master</span></code> or some
older, stable revision. The actual <code class="docutils literal notranslate"><span class="pre">vx.y.z</span></code> release tags are set
on revisions in the corresponding <code class="docutils literal notranslate"><span class="pre">release-x.y</span></code> branch.</p>
<p>Releases and the corresponding images are never changed. If something
goes wrong after setting a tag (such as detecting a bug while testing the
release images), a new release is created.</p>
<p>Container images reference a floating base image. Whatever version of
that was current at the time of building the PMEM-CSI image then
serves as base for the release. To ensure that the release image
remains secure, it is scanned for known vulnerabilities regularly and
a new release is prepared manually, if needed. The new release then
uses a newer base image.</p>
</section>
<section id="tagging">
<h3>Tagging<a class="headerlink" href="#tagging" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">devel</span></code> and <code class="docutils literal notranslate"><span class="pre">master</span></code> branch build and use the <code class="docutils literal notranslate"><span class="pre">canary</span></code> version of
the PMEM-CSI driver images. Before tagging a release, all of those
version strings need to be replaced by the upcoming version. All
tagged releases then use the image that corresponds to that release.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">hack/set-version.sh</span></code> script can be used to set these versions.
The modified files then need to be committed. Merging such a commit
triggers a rebuild of the <code class="docutils literal notranslate"><span class="pre">devel</span></code> branch, but does not yet produce a
release; the actual image is pushed only when there is a tag that
corresponds to the version embedded in the source code. The
Jenkinsfile ensures that.</p>
</section>
<section id="release-checklist">
<h3>Release checklist<a class="headerlink" href="#release-checklist" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Create a new <code class="docutils literal notranslate"><span class="pre">release-x.y</span></code> branch.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">hack/set-version.sh</span> <span class="pre">vx.y.z</span></code> and commit the modified files.</p></li>
<li><p>Push to <code class="docutils literal notranslate"><span class="pre">origin</span></code>.</p></li>
<li><p><a class="reference external" href="https://github.com/intel/pmem-csi/releases/new">Create a draft
release</a> for that
new branch, including a change log gathered from new commits.</p></li>
<li><p>Review the change log.</p></li>
<li><p>Tag <code class="docutils literal notranslate"><span class="pre">vx.y.z</span></code> manually and push to origin.</p></li>
<li><p>Wait for a successful CI <a class="reference external" href="https://cloudnative-k8sci.southcentralus.cloudapp.azure.com/view/pmem-csi/job/pmem-csi/view/tags/">build for that
tag</a>
and promotion of the resulting images to <a class="reference external" href="https://hub.docker.com/r/intel/pmem-csi-driver/tags?page=1&amp;ordering=last_updated">Docker
Hub</a>.</p></li>
<li><p>Publish the GitHub release.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">hack/merge-release.sh</span></code> on the “devel” branch and push the
fabricated merge commit. This documents that “devel” is at least
as recent as the new release.</p></li>
<li><p>On the devel branch, add the new release to the main README.md and
<code class="docutils literal notranslate"><span class="pre">.github/workflows/publish.yml</span></code>. Merge into devel, then cherry-pick
into <em>all</em> release branches that might still get changes. Otherwise
building the old release will cause the docsite to be generated
without the new release.</p></li>
</ul>
</section>
<section id="release-pmem-csi-operator">
<h3>Release PMEM-CSI operator<a class="headerlink" href="#release-pmem-csi-operator" title="Permalink to this headline"></a></h3>
<p>Follow the steps below to publish new operator release to
<a class="reference external" href="https://operatorhub.io">OperatorHub</a>:</p>
<ul class="simple">
<li><p>Generate OLM package bundle for the new release</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>operator-clean-bundle
<span class="gp">$ </span>make<span class="w"> </span>operator-generate-bundle<span class="w"> </span><span class="nv">VERSION</span><span class="o">=</span>&lt;X.Y.Z&gt;<span class="w"> </span><span class="nv">REPLACES</span><span class="o">=</span>&lt;X.Y.Z&gt;<span class="w"> </span><span class="c1"># semantic version numbers without v prefix</span>
</pre></div>
</div>
<p>Running the above command generates the OLM package bundle files under <code class="docutils literal notranslate"><span class="pre">deploy/olm-bundle/&lt;X.Y.Z&gt;</span></code></p>
<ul class="simple">
<li><p>Clone <code class="docutils literal notranslate"><span class="pre">operator-framework/community-operators</span></code> repository</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/operator-framework/community-operators.git
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the generated catalog files. Commit the changes and submit a pull
request to
<a class="reference external" href="https://github.com/operator-framework/community-operators">community-operators</a> repository.</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cp<span class="w"> </span>-r<span class="w"> </span>&lt;PMEM-CSI_ROOT&gt;/deploy/olm-bundle/*<span class="w"> </span>&lt;COMMUNITY-OPERATORS_ROOT&gt;/upstream-community-operators/pmem-csi-operator/
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>&lt;COMMUNITY-OPERATORS_ROOT&gt;
<span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>upstream-community-operators/pmem-csi-operator/
<span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>-s<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Updating PMEM-CSI Operator to version &lt;X.Y.Z&gt;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="apis">
<h2>APIs<a class="headerlink" href="#apis" title="Permalink to this headline"></a></h2>
<section id="csi-api">
<h3>CSI API<a class="headerlink" href="#csi-api" title="Permalink to this headline"></a></h3>
<p>Kubernetes* CSI API is exposed over a Unix domain socket. CSI operations
are executed as gRPC calls. Input data is allowed as permitted by CSI
specification. Output data is formatted as a gRPC response.</p>
<p>The following CSI operations are supported, with arguments specified by
the CSI specification: CreateVolume, DeleteVolume, StageVolume,
UnstageVolume, PublishVolume, UnpublishVolume, ListVolumes,
GetCapacity, GetCapabilities, GetPluginInfo, and GetPluginCapabilities.</p>
</section>
<section id="network-ports">
<h3>Network ports<a class="headerlink" href="#network-ports" title="Permalink to this headline"></a></h3>
<p>Network ports are opened as configured in manifest files:</p>
<ul class="simple">
<li><p>metrics endpoint: typical port values 10010 (PMEM-CSI) and 10011
(external-provisioner)</p></li>
<li><p>webhook endpoint: disabled by default, port chosen when <a class="reference external" href="install.html#enable-scheduler-extensions">enabling the scheduler extensions</a></p></li>
</ul>
</section>
<section id="local-sockets">
<h3>Local sockets<a class="headerlink" href="#local-sockets" title="Permalink to this headline"></a></h3>
<p>The Kubernetes CSI API is used over a local socket inside the same host.</p>
<ul class="simple">
<li><p>unix:///var/lib/kubelet/plugins/pmem-csi-reg.sock</p></li>
<li><p>unix:///var/lib/kubelet/plugins/pmem-csi/csi.sock</p></li>
<li><p>unix:///var/lib/kubelet/plugins/pmem-csi/csi-controller.sock</p></li>
</ul>
</section>
<section id="command-line-arguments">
<h3>Command line arguments<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline"></a></h3>
<p>See the <code class="docutils literal notranslate"><span class="pre">main.go</span></code> files of the
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/pkg/pmem-csi-driver/main.go">pmem-csi-driver</a> and
the <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/pkg/pmem-csi-operator/main.go">pmem-csi-operator</a> commands.</p>
</section>
<section id="environment-variables">
<h3>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline"></a></h3>
<p>TEST_WORK is used by registry server unit-test code to specify the path to
certificates in the test system.</p>
<blockquote>
<div><p>Note: THIS IS NOT USED IN PRODUCTION.</p>
</div></blockquote>
<p>NODE_NAME is a copy of the node name set for the pod which runs the
<code class="docutils literal notranslate"><span class="pre">external-provisioner</span></code> on each node.</p>
</section>
<section id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this headline"></a></h3>
<p>The klog.Info statements are used via the verbosity checker using the following levels:</p>
<ul class="simple">
<li><p>klog.V(3) - Generic information. Level 3 is the default Info log level in
pmem-csi, and example deployment files set this level for production
configuration.</p></li>
<li><p>klog.V(4) - Elevated verbosity messages.</p></li>
<li><p>klog.V(5) - Even more verbose messages, useful for debugging and issue
resolving. This level is used in testing type of deployment examples.</p></li>
</ul>
<p>These are <em>not</em> the same levels as in the <a class="reference external" href="https://github.com/kubernetes/community/blob/4eeba4d57bed01502cb09598a74d21671d4ee876/contributors/devel/sig-instrumentation/logging.md">Kubernetes logging conventions</a>.</p>
<p>There are also messages using klog.Warning, klog.Error, klog.Fatal,
and their formatted counterparts.</p>
</section>
</section>
<section id="performance-and-resource-measurements">
<h2>Performance and resource measurements<a class="headerlink" href="#performance-and-resource-measurements" title="Permalink to this headline"></a></h2>
<p>The <a class="reference external" href="https://github.com/kubernetes-sigs/metrics-server">metrics
server</a> is needed
for <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">top</span> <span class="pre">node</span></code> and <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">top</span> <span class="pre">pod</span></code>. In the QEMU cluster it
has to be installed with insecure TLS because of
https://github.com/kubernetes/kubeadm/issues/2028. This can be done with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kustomize build deploy/kustomize/metrics-server | kubectl create -f -</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Vertical</span> <span class="pre">Pod</span> <span class="pre">Autoscaler</span></code> can be used to determine resource
requirements of the PMEM-CSI pods. The <code class="docutils literal notranslate"><span class="pre">hack/setup-va.sh</span></code> script
checks out the source code under <code class="docutils literal notranslate"><span class="pre">_work</span></code> and installs it.</p>
<p>For PMEM-CSI running in the default namespace, VPA can be instructed
to provide recommendations with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -k deploy/kustomize/vpa-for-pmem-csi/</span>
</pre></div>
</div>
<p>Resource requirements depend on the workload. To generate some load, run</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">make test_e2e TEST_E2E_FOCUS=lvm-production.*late.binding.*stress.test</span>
</pre></div>
</div>
<p>Alternatively, one can run the
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/hack/stress-driver.sh"><code class="docutils literal notranslate"><span class="pre">hack/stress-driver.sh</span></code></a>
helper script to generate load on the driver</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ROUNDS=500 VOL_COUNT=5 ./hack/stress-driver.sh</span>
</pre></div>
</div>
<p>Now resource recommendations can be retrieved with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get vpa</span>
<span class="go">kubectl describe vpa</span>
<span class="go">kubectl get vpa pmem-csi-node -o jsonpath=&#39;{range .status.recommendation.containerRecommendations[*]}{.containerName}{&quot;:\n\tRequests: &quot;}{.lowerBound}{&quot;\n\tLimits: &quot;}{.upperBound}{&quot;\n&quot;}{end}&#39;</span>
</pre></div>
</div>
<p>The default resource requirements used for the driver deployments by the
operator are chosen from the VPA recommendations described in this section
when using the <code class="docutils literal notranslate"><span class="pre">stress-driver.sh</span></code> script.</p>
</section>
<section id="accessing-system-directories-in-a-container">
<h2>Accessing system directories in a container<a class="headerlink" href="#accessing-system-directories-in-a-container" title="Permalink to this headline"></a></h2>
<p>The PMEM-CSI driver runs as a container, but it needs access to
system directories /sys and /dev. Two related potential problems that have
been diagnosed so far are listed below.</p>
<section id="read-only-access-to-sys">
<h3>Read-only access to /sys<a class="headerlink" href="#read-only-access-to-sys" title="Permalink to this headline"></a></h3>
<p>In some deployment schemes, /sys remains mounted read-only in the
container running pmsm-csi-driver. This creates a problem for the
driver that needs write access to /sys for namespaces management
operations. There is start-time check for read-write mount of /sys in
the code. An error in the pod log <code class="docutils literal notranslate"><span class="pre">pmem-driver:</span> <span class="pre">Failed</span> <span class="pre">to</span> <span class="pre">run</span> <span class="pre">driver:</span> <span class="pre">FATAL:</span> <span class="pre">/sys</span> <span class="pre">mounted</span> <span class="pre">read-only,</span> <span class="pre">can</span> <span class="pre">not</span> <span class="pre">operate</span></code> is the sign of such a
state.</p>
</section>
<section id="access-to-dev-of-host">
<h3>Access to /dev of host<a class="headerlink" href="#access-to-dev-of-host" title="Permalink to this headline"></a></h3>
<p>Containers runtime may not pass /dev from host into the
container. If the /dev/ of the host is not accessible in the PMEM-CSI
container, access will fail to the newly created block device /dev/pmemX.Y
which will not be visible inside the container. The driver does not detect
the root cause of that problem during start-up, but only when a volume
creation has failed. This problem can be avoided by specifying an
explicit mount of /dev in the PMEM-CSI manifest.</p>
</section>
</section>
<section id="repository-elements-that-are-generated-or-created-separately">
<h2>Repository elements that are generated or created separately<a class="headerlink" href="#repository-elements-that-are-generated-or-created-separately" title="Permalink to this headline"></a></h2>
<p>Here are creation and update notes for the elements in the repository
that are not hand-edited.</p>
<section id="top-level-readme-diagrams-describing-lvm-and-direct-device-modes">
<h3>Top-level README diagrams describing LVM and Direct device modes<a class="headerlink" href="#top-level-readme-diagrams-describing-lvm-and-direct-device-modes" title="Permalink to this headline"></a></h3>
<p>Two diagrams are created with
<a class="reference external" href="https://en.wikipedia.org/wiki/Dia_(software)"><em>dia</em> drawing program</a>.
The <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/docs/diagrams/pmem-csi.dia">single source file</a> has
layers: {common, lvm, direct} so that two diagram variants can be produced
from a single source. Image files are produced by saving in PNG format with
correct set of layers visible.
The PNG files are committed as repository elements in
docs/images/devicemodes/.</p>
</section>
<section id="top-level-readme-diagram-describing-communication-channels">
<h3>Top-level README diagram describing communication channels<a class="headerlink" href="#top-level-readme-diagram-describing-communication-channels" title="Permalink to this headline"></a></h3>
<p>This diagram was created with the
<a class="reference external" href="https://en.wikipedia.org/wiki/Dia_(software)"><em>dia</em> drawing program</a> using
a <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/docs/diagrams/pmem-csi-communication-diagram.dia">source file</a>.</p>
<p>An image file is produced by saving in PNG format.
The PNG file is committed as a
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/docs/images/communication/pmem-csi-communication-diagram.png">repository element</a>.</p>
</section>
<section id="diagrams-describing-provisioning-sequence">
<h3>Diagrams describing provisioning sequence<a class="headerlink" href="#diagrams-describing-provisioning-sequence" title="Permalink to this headline"></a></h3>
<p>Two diagrams are generated using the
<a class="reference external" href="http://plantuml.com/">plantuml program</a>.
Source files:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/docs/diagrams/sequence.wsd">source file for regular sequence</a></p></li>
</ul>
<p>The PNG files are committed as repository elements in docs/images/sequence/.</p>
</section>
<section id="table-of-contents-in-readme-and-development">
<h3>Table of Contents in README and DEVELOPMENT<a class="headerlink" href="#table-of-contents-in-readme-and-development" title="Permalink to this headline"></a></h3>
<p>A Table of Contents (TOC) can be generated using multiple methods.</p>
<ul>
<li><p>One method  is to use <a class="reference external" href="https://pandoc.org/">pandoc</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pandoc<span class="w"> </span>-s<span class="w"> </span>-t<span class="w"> </span>markdown_github<span class="w"> </span>--toc<span class="w"> </span>README.md<span class="w"> </span>-o<span class="w"> </span>/tmp/temp.md
</pre></div>
</div>
<p>Then check and hand-pick generated TOC part(s) from /tmp/temp.md and insert
them in the desired location.
Note that pandoc is known to produce incorrect TOC entries if headers
contain special characters. This means that TOC generation will be more
reliable if we avoid non-letter-or-number characters in the headers.</p>
</li>
<li><p>Another method is to use the emacs command markdown-toc-generate-toc and
manually check and edit the generated part: we do not show generated
third-level headings in README.md.</p></li>
</ul>
</section>
</section>
<section id="build-edit-and-deploy-the-read-the-docs-site">
<h2>Build, edit, and deploy the Read the Docs site<a class="headerlink" href="#build-edit-and-deploy-the-read-the-docs-site" title="Permalink to this headline"></a></h2>
<p>The PMEM-CSI documentation is available as in-repo READMEs and as a GitHub*
hosted <a class="reference external" href="https://intel.github.io/pmem-csi">website</a>. The website is created
using the <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> documentation generator and
the well-known <a class="reference external" href="https://sphinx-rtd-theme.readthedocs.io/">Read the Docs</a>
theme.</p>
<section id="build">
<h3>Build<a class="headerlink" href="#build" title="Permalink to this headline"></a></h3>
<p>Building the documentation requires Python* 3.x and venv.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>vhtml
</pre></div>
</div>
</section>
<section id="edit">
<h3>Edit<a class="headerlink" href="#edit" title="Permalink to this headline"></a></h3>
<p>Sphinx uses <a class="reference external" href="https://docutils.sourceforge.io/docs/ref/rst/restructuredtext.html">reStructuredText</a> (reST) as the primary document source type but can be
extended to use Markdown by adding the <code class="docutils literal notranslate"><span class="pre">recommonmark</span></code> and
<code class="docutils literal notranslate"><span class="pre">sphinx_markdown_tables</span></code> extensions (see <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/conf.json">conf.json</a>).</p>
<p>Change the navigation tree or add documents by updating the <code class="docutils literal notranslate"><span class="pre">toctree</span></code>. The
main <code class="docutils literal notranslate"><span class="pre">toctree</span></code> is in <code class="docutils literal notranslate"><span class="pre">index.rst</span></code>:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">toctree</span><span class="p">::</span>
   <span class="nc">:maxdepth:</span> 2

   README.md
   docs/design.md
   docs/install.md
   docs/DEVELOPMENT.md
   docs/autotest.md
   examples/readme.rst
   Project GitHub repository &lt;https://github.com/intel/pmem-csi&gt;
</pre></div>
</div>
<p>reST files, Markdown files, and URLs can be added to a <code class="docutils literal notranslate"><span class="pre">toctree</span></code>. The
<code class="docutils literal notranslate"><span class="pre">:maxdepth:</span></code> argument dictates the number of header levels to be
displayed on that page. This website replaces the <code class="docutils literal notranslate"><span class="pre">index.html</span></code> output of
this project with a redirect to <code class="docutils literal notranslate"><span class="pre">README.html</span></code> (the conversion of the top
level README) to more closely match the in-repo documentation.</p>
<p>Any reST or Markdown file not referenced by a <code class="docutils literal notranslate"><span class="pre">toctree</span></code> will generate a
warning in the build. This document has a <code class="docutils literal notranslate"><span class="pre">toctree</span></code> in:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">index.rst</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">examples/readme.rst</span></code></p></li>
</ol>
<p>Files or directories that are intentionally not referenced can be excluded
in <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/conf.json"><code class="docutils literal notranslate"><span class="pre">conf.json</span></code></a>.</p>
<p>NOTE: Though GitHub can parse reST files, the <code class="docutils literal notranslate"><span class="pre">toctree</span></code> directive is Sphinx
specific, so it is not understood by GitHub. <code class="docutils literal notranslate"><span class="pre">examples/readme.rst</span></code> is a
good example. Adding the <code class="docutils literal notranslate"><span class="pre">:hidden:</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">toctree</span></code> directive
means that the <code class="docutils literal notranslate"><span class="pre">toctree</span></code> is not displayed in the Sphinx built version of
the page.</p>
</section>
<section id="custom-link-handling">
<h3>Custom link handling<a class="headerlink" href="#custom-link-handling" title="Permalink to this headline"></a></h3>
<p>This project has some custom capabilities added to the <a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/conf.py">conf.py</a> to
fix or improve how Sphinx generates the HTML site.</p>
<ol>
<li><p>Markdown files: Converts references to Markdown files that include
anchors.</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>[<span class="nt">configuration options</span>](<span class="na">autotest.md#configuration-options</span>)
</pre></div>
</div>
</li>
<li><p>reST files: Fixes explicit links to Markdown files.</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="s">`Google Cloud Engine </span><span class="si">&lt;gce.md&gt;</span><span class="s">`__</span>
</pre></div>
</div>
</li>
<li><p>Markdown files: Fixes references to reST files.</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>[<span class="nt">Application examples</span>](<span class="na">examples/readme.rst</span>)
</pre></div>
</div>
</li>
<li><p>Markdown files: Fixes links to files and directories within the GitHub
repo.</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>[<span class="nt">Makefile</span>](<span class="na">/Makefile</span>)
[<span class="nt">deploy/kustomize</span>](<span class="na">/deploy/kustomize</span>)
</pre></div>
</div>
<p>Links to files can be fixed in one of two ways, which can be set in the
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/8a22a3ed1b7041733cfef8433cd3f68b0346b347/conf.py">conf.py</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">baseBranch</span> <span class="o">=</span> <span class="s2">&quot;devel&quot;</span>
<span class="n">useGitHubURL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">commitSHA</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GITHUB_SHA&#39;</span><span class="p">)</span>
<span class="n">githubBaseURL</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/intelkevinputnam/pmem-csi/&quot;</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">useGitHubURL</span></code> is set to True, it will try to create links based on
your <code class="docutils literal notranslate"><span class="pre">githubBaseURL</span></code> and the SHA for the commit to the GitHub repo
determined by the GitHub workflow on merge. If there is no SHA available,
it will use the value of <code class="docutils literal notranslate"><span class="pre">baseBranch</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">useGitHubURL</span></code> is set to False, it will copy the files to the HTML
output directory and provide links to that location.</p>
<p>NOTE: Links to files and directories should use absolute paths relative
to the repo (see Makefile and deploy/kustomize above). This will work
both for the Sphinx build and when viewing in the GitHub repo.</p>
<p>Links to directories are always converted to links to the GitHub
repository.</p>
</li>
</ol>
</section>
<section id="deploying-with-github-actions">
<h3>Deploying with GitHub actions<a class="headerlink" href="#deploying-with-github-actions" title="Permalink to this headline"></a></h3>
<p>The publish
<a class="reference external" href="https://github.com/intel/pmem-csi/blob/devel/.github/workflows/publish.yml">workflow</a>
is run each time a commit is made to the branches references by that file and pushes
the rendered HTML to the gh-pages branch. Other rules can be created
for other branches.</p>
<p>NOTE: Create a secret called <code class="docutils literal notranslate"><span class="pre">ACCESS_TOKEN</span></code> in repo&gt;settings&gt;secrets with
a <a class="reference external" href="https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line">token</a> generated by a user
with write privileges to enable the automated push to the gh-pages branch.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="Installation and Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="autotest.html" class="btn btn-neutral float-right" title="Automated testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Intel Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>